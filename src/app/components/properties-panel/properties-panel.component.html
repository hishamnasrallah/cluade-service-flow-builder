<div class="properties-panel">
  <div class="panel-header">
    <h3>Properties</h3>
    <button mat-icon-button (click)="closePanel()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="panel-content" *ngIf="node">
    <form [formGroup]="propertiesForm" (ngSubmit)="saveChanges()">

      <!-- Basic Properties -->
      <mat-card class="properties-section">
        <mat-card-header>
          <mat-card-title>Basic Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Label</mat-label>
            <input matInput formControlName="label">
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Type</mat-label>
            <mat-select formControlName="type" (selectionChange)="onTypeChange()">
              <mat-option value="start">Start</mat-option>
              <mat-option value="end">End</mat-option>
              <mat-option value="page">Page</mat-option>
              <mat-option value="decision">Decision</mat-option>
              <mat-option value="condition">Condition</mat-option>
              <mat-option value="field">Field</mat-option>
              <mat-option value="validation">Validation</mat-option>
              <mat-option value="calculation">Calculation</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" rows="3"></textarea>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <!-- Position -->
      <mat-card class="properties-section">
        <mat-card-header>
          <mat-card-title>Position</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="position-inputs">
            <mat-form-field appearance="outline">
              <mat-label>X</mat-label>
              <input matInput type="number" formControlName="x">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Y</mat-label>
              <input matInput type="number" formControlName="y">
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Type-specific Properties -->
      <div [ngSwitch]="propertiesForm.get('type')?.value">

        <!-- Page Properties -->
        <mat-card class="properties-section" *ngSwitchCase="'page'">
          <mat-card-header>
            <mat-card-title>Page Configuration</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Service</mat-label>
              <mat-select formControlName="service">
                <mat-option *ngFor="let service of services" [value]="service.id">
                  {{service.name}}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Page Name</mat-label>
              <input matInput formControlName="pageName">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Page Name (Arabic)</mat-label>
              <input matInput formControlName="pageNameAra">
            </mat-form-field>

            <mat-slide-toggle formControlName="activeInd">
              Active Page
            </mat-slide-toggle>
          </mat-card-content>
        </mat-card>

        <!-- Field Properties -->
        <mat-card class="properties-section" *ngSwitchCase="'field'">
          <mat-card-header>
            <mat-card-title>Field Configuration</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Field Name</mat-label>
              <input matInput formControlName="fieldName">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Display Name</mat-label>
              <input matInput formControlName="fieldDisplayName">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Field Type</mat-label>
              <mat-select formControlName="fieldType">
                <mat-option *ngFor="let type of fieldTypes" [value]="type.id">
                  {{type.name}}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <div class="field-options">
              <mat-slide-toggle formControlName="mandatory">
                Mandatory Field
              </mat-slide-toggle>

              <mat-slide-toggle formControlName="hidden">
                Hidden Field
              </mat-slide-toggle>

              <mat-slide-toggle formControlName="disabled">
                Disabled Field
              </mat-slide-toggle>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Sequence</mat-label>
              <input matInput type="number" formControlName="sequence">
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Condition Properties -->
        <mat-card class="properties-section" *ngSwitchCase="'condition'">
          <mat-card-header>
            <mat-card-title>Condition Logic</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Target Field</mat-label>
              <mat-select formControlName="targetField">
                <mat-option *ngFor="let field of availableFields" [value]="field.id">
                  {{field._field_display_name}}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <div class="condition-builder">
              <h4>Condition Rules</h4>
              <div *ngFor="let rule of conditionRules; let i = index" class="condition-rule">
                <mat-form-field appearance="outline">
                  <mat-label>Field</mat-label>
                  <input matInput [(ngModel)]="rule.field" [ngModelOptions]="{standalone: true}">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Operation</mat-label>
                  <mat-select [(ngModel)]="rule.operation" [ngModelOptions]="{standalone: true}">
                    <mat-option value="=">=</mat-option>
                    <mat-option value="!=">!=</mat-option>
                    <mat-option value=">">></mat-option>
                    <mat-option value="<"><</mat-option>
                    <mat-option value=">=">>=</mat-option>
                    <mat-option value="<="><=</mat-option>
                    <mat-option value="contains">Contains</mat-option>
                    <mat-option value="startswith">Starts With</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Value</mat-label>
                  <input matInput [(ngModel)]="rule.value" [ngModelOptions]="{standalone: true}">
                </mat-form-field>

                <button mat-icon-button color="warn" (click)="removeConditionRule(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <button mat-stroked-button (click)="addConditionRule()">
                <mat-icon>add</mat-icon>
                Add Rule
              </button>
            </div>
          </mat-card-content>
        </mat-card>

      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button mat-raised-button color="primary" type="submit" [disabled]="propertiesForm.invalid">
          <mat-icon>save</mat-icon>
          Save Changes
        </button>
        <button mat-stroked-button type="button" (click)="resetForm()">
          <mat-icon>refresh</mat-icon>
          Reset
        </button>
        <button mat-stroked-button color="warn" type="button" (click)="deleteNode()">
          <mat-icon>delete</mat-icon>
          Delete Node
        </button>
      </div>
    </form>
  </div>
</div>
